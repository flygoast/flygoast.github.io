<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"just4coding.com","root":"/","scheme":"Gemini","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="之前的文章&lt;&lt;QEMU虚拟机内识别ivshmem设备&gt;&gt;介绍了在虚拟机内通过用户态程序访问ivshmem设备的共享内存。在虚拟机之间或者宿主机与虚拟机之间通过共享内存进行通信的情形下，共享内存的两端必须依赖轮询方式来实现通知机制。这种方式是ivshmem提供的ivshmem-plain的使用方式。除此之外，ivshmem还提供了ivshmem-doorbell的使用方式，它">
<meta property="og:type" content="article">
<meta property="og:title" content="ivshmem PCI设备中断机制驱动示例">
<meta property="og:url" content="http://just4coding.com/2021/09/25/ivshmem-pci/index.html">
<meta property="og:site_name" content="Just For Coding">
<meta property="og:description" content="之前的文章&lt;&lt;QEMU虚拟机内识别ivshmem设备&gt;&gt;介绍了在虚拟机内通过用户态程序访问ivshmem设备的共享内存。在虚拟机之间或者宿主机与虚拟机之间通过共享内存进行通信的情形下，共享内存的两端必须依赖轮询方式来实现通知机制。这种方式是ivshmem提供的ivshmem-plain的使用方式。除此之外，ivshmem还提供了ivshmem-doorbell的使用方式，它">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-25T11:00:59.000Z">
<meta property="article:modified_time" content="2026-01-04T08:37:33.495Z">
<meta property="article:author" content="flygoast">
<meta property="article:tag" content="Virtualization">
<meta property="article:tag" content="Ivshmem">
<meta property="article:tag" content="Qemu">
<meta property="article:tag" content="PCI">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://just4coding.com/2021/09/25/ivshmem-pci/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>ivshmem PCI设备中断机制驱动示例 | Just For Coding</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1b2d0e9aa90f26734ba45aad8357b186";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Just For Coding</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Keep learning, keep living...</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://just4coding.com/2021/09/25/ivshmem-pci/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="flygoast">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Just For Coding">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ivshmem PCI设备中断机制驱动示例
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-25 19:00:59" itemprop="dateCreated datePublished" datetime="2021-09-25T19:00:59+08:00">2021-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2026-01-04 16:37:33" itemprop="dateModified" datetime="2026-01-04T16:37:33+08:00">2026-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Virtualization/" itemprop="url" rel="index">
                    <span itemprop="name">Virtualization</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前的文章<a href="/2021/09/12/qemu-ivshmem/">&lt;&lt;QEMU虚拟机内识别ivshmem设备&gt;&gt;</a>介绍了在虚拟机内通过用户态程序访问<code>ivshmem</code>设备的共享内存。在虚拟机之间或者宿主机与虚拟机之间通过共享内存进行通信的情形下，共享内存的两端必须依赖轮询方式来实现通知机制。这种方式是<code>ivshmem</code>提供的<code>ivshmem-plain</code>的使用方式。除此之外，<code>ivshmem</code>还提供了<code>ivshmem-doorbell</code>的使用方式，它提供了基于中断的通知机制。</p>
<p><code>ivshmem-doorbell</code>提供了两种中断方式，一种是传统的基于<code>INTx</code>的中断, 它主要使用<code>BAR0</code>的<code>Interrupt Mask</code>和<code>Interrupt Status</code>两个寄存器；另一种是基于<code>MSI-X</code>的中断，它主要使用<code>BAR0</code>的<code>IVPosition</code>和<code>Doorbell</code>两个寄存器。参考共享的设备端叫做<code>peer</code>。<code>IVPosition</code>寄存器存储该<code>peer</code>的数字标识符(0-65535), 称做<code>peer_id</code>。该寄存器为只读寄存器。而<code>Doorbell</code>寄存器为只写寄存器。<code>ivshmem-doorbell</code>支持多个中断向量，写入<code>Doorbell</code>寄存器则触发共享该内存的某个<code>peer</code>的某个中断。<code>Doorbell</code>为<code>32</code>位，低<code>16</code>位为<code>peer_id</code>，而高<code>16</code>位为中断向量号(这里是从<code>0</code>开始的顺序号，而非<code>PCI</code>驱动在Guest虚拟机内部所申请的向量号)。</p>
<p>使用<code>ivshmem-doorbell</code>机制需要运行<code>ivshmem-server</code>。<code>ivshmem-server</code>根据参数创建共享内存，并通过监听本地<code>UNIX DOMAIN SOCKET</code>等待共享内存的<code>peer</code>来连接。添加了<code>ivshmem-doorbell</code>设备的<code>QEMU</code>进程会连接该<code>socket</code>, 从而获取<code>ivshmem-server</code>所分配的一个<code>peer_id</code>。<code>ivshmem-doorbell</code>支持多个中断向量，<code>ivshmem-server</code>会为<code>ivshmem</code>虚拟<code>PCI</code>设备支持的每个中断向量创建一个<code>eventfd</code>，并将共享内存以及为所有客户端中断向量所创建的<code>eventfd</code>都通过<code>SCM_RIGHTS</code>机制传递给所有客户端进程。这样所有的<code>peer</code>便都具备了独立的两两之间的通知通道。之后在虚拟机内通过触发<code>ivshmem</code>虚拟<code>PCI</code>设备的<code>DOORBELL</code>寄存器的写入，虚拟机的<code>QEMU</code>进程便会通过<code>DOORBELL</code>寄存器中的<code>peer_id</code>和中断向量号来找到相应的<code>eventfd</code>，从而通知到对端的<code>QEMU</code>进程来产生相应的<code>PCI</code>中断。</p>
<p>要使用中断机制，用户态程序是无能为力的，需要编写相应的<code>PCI</code>驱动来实现。本文通过一个简单的<code>PCI</code>驱动示例来说明<code>ivshmem-doorbell</code>的<code>MSI-X</code>中断机制的使用。</p>
<span id="more"></span>

<p><code>ivpci.c</code>代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pci.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pci_regs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRV_NAME        <span class="string">&quot;ivpci&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRV_VERSION     <span class="string">&quot;0.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PFX             <span class="string">&quot;[IVPCI] &quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRV_FILE_FMT    DRV_NAME<span class="string">&quot;%d&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IVPOSITION_OFF  0x08    <span class="comment">/* VM ID */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOORBELL_OFF    0x0c    <span class="comment">/* Doorbell */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MAGIC         (<span class="string">&#x27;f&#x27;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RING          _IOW(IOCTL_MAGIC, 1, u32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_WAIT          _IO(IOCTL_MAGIC, 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_IVPOSITION    _IOR(IOCTL_MAGIC, 3, u32)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> g_max_devices = <span class="number">2</span>;</span><br><span class="line">MODULE_PARM_DESC(g_max_devices, <span class="string">&quot;number of devices can be supported&quot;</span>);</span><br><span class="line">module_param(g_max_devices, <span class="type">int</span>, <span class="number">0400</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span>      *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>         <span class="title">cdev</span>;</span></span><br><span class="line">    <span class="type">int</span>                 minor;</span><br><span class="line"></span><br><span class="line">    u8                  revision;</span><br><span class="line">    u32                 ivposition;</span><br><span class="line"></span><br><span class="line">    u8 __iomem          *base_addr;</span><br><span class="line">    u8 __iomem          *regs_addr;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar0_addr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar0_len;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar1_addr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar1_len;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar2_addr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        bar2_len;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>                (*msix_names)[<span class="number">256</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msix_entry</span>   *<span class="title">msix_entries</span>;</span></span><br><span class="line">    <span class="type">int</span>                 nvectors;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> event_toggle;</span><br><span class="line">DECLARE_WAIT_QUEUE_HEAD(wait_queue);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* store major device number shared by all ivshmem devices */</span></span><br><span class="line"><span class="type">static</span> <span class="type">dev_t</span> g_ivpci_devno;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span>  g_ivpci_major;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">g_ivpci_class</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* number of devices owned by this driver */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> g_ivpci_count;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">g_ivpci_devs</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_device_id</span> <span class="title">ivpci_id_table</span>[] =</span> &#123;</span><br><span class="line">    &#123; <span class="number">0x1af4</span>, <span class="number">0x1110</span>, PCI_ANY_ID, PCI_ANY_ID, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123; <span class="number">0</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">MODULE_DEVICE_TABLE(pci, ivpci_id_table);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> ivpci_private *<span class="title function_">ivpci_get_private</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; g_max_devices; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_ivpci_devs[i].dev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> &amp;g_ivpci_devs[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> ivpci_private *<span class="title function_">ivpci_find_private</span><span class="params">(<span class="type">int</span> minor)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; g_max_devices; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_ivpci_devs[i].dev != <span class="literal">NULL</span> &amp;&amp; g_ivpci_devs[i].minor == minor) &#123;</span><br><span class="line">            <span class="keyword">return</span> &amp;g_ivpci_devs[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">ivpci_interrupt</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span> =</span> dev_id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(ivpci_dev == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> IRQ_NONE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;interrupt: %d\n&quot;</span>, irq);</span><br><span class="line"></span><br><span class="line">    event_toggle = <span class="number">1</span>;</span><br><span class="line">    wake_up_interruptible(&amp;wait_queue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ivpci_request_msix_vectors</span><span class="params">(<span class="keyword">struct</span> ivpci_private *ivpci_dev, <span class="type">int</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">    ret = -EINVAL;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;request msi-x vectors: %d\n&quot;</span>, n);</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;nvectors = n;</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;msix_entries = kmalloc(n * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msix_entry),</span><br><span class="line">            GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (ivpci_dev-&gt;msix_entries == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;msix_names = kmalloc(n * <span class="keyword">sizeof</span>(*ivpci_dev-&gt;msix_names),</span><br><span class="line">            GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (ivpci_dev-&gt;msix_names == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> free_entries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        ivpci_dev-&gt;msix_entries[i].entry = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = pci_enable_msix_exact(ivpci_dev-&gt;dev, ivpci_dev-&gt;msix_entries, n);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;unable to enable msix: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> free_names;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ivpci_dev-&gt;nvectors; i++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(ivpci_dev-&gt;msix_names[i], <span class="keyword">sizeof</span>(*ivpci_dev-&gt;msix_names),</span><br><span class="line">                <span class="string">&quot;%s%d-%d&quot;</span>, DRV_NAME, ivpci_dev-&gt;minor, i);</span><br><span class="line"></span><br><span class="line">        ret = request_irq(ivpci_dev-&gt;msix_entries[i].<span class="built_in">vector</span>,</span><br><span class="line">                ivpci_interrupt, <span class="number">0</span>, ivpci_dev-&gt;msix_names[i], ivpci_dev);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;unable to allocate irq for &quot;</span> \</span><br><span class="line">                    <span class="string">&quot;msix entry %d with vector %d\n&quot;</span>, i,</span><br><span class="line">                    ivpci_dev-&gt;msix_entries[i].<span class="built_in">vector</span>);</span><br><span class="line">            <span class="keyword">goto</span> release_irqs;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev,</span><br><span class="line">                PFX <span class="string">&quot;irq for msix entry: %d, vector: %d\n&quot;</span>,</span><br><span class="line">                i, ivpci_dev-&gt;msix_entries[i].<span class="built_in">vector</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">release_irqs:</span><br><span class="line">    <span class="keyword">for</span> ( ; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        free_irq(ivpci_dev-&gt;msix_entries[i - <span class="number">1</span>].<span class="built_in">vector</span>, ivpci_dev);</span><br><span class="line">    &#125;</span><br><span class="line">    pci_disable_msix(ivpci_dev-&gt;dev);</span><br><span class="line"></span><br><span class="line">free_names:</span><br><span class="line">    kfree(ivpci_dev-&gt;msix_names);</span><br><span class="line"></span><br><span class="line">free_entries:</span><br><span class="line">    kfree(ivpci_dev-&gt;msix_entries);</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ivpci_free_msix_vectors</span><span class="params">(<span class="keyword">struct</span> ivpci_private *ivpci_dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = ivpci_dev-&gt;nvectors; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        free_irq(ivpci_dev-&gt;msix_entries[i - <span class="number">1</span>].<span class="built_in">vector</span>, ivpci_dev);</span><br><span class="line">    &#125;</span><br><span class="line">    pci_disable_msix(ivpci_dev-&gt;dev);</span><br><span class="line"></span><br><span class="line">    kfree(ivpci_dev-&gt;msix_names);</span><br><span class="line">    kfree(ivpci_dev-&gt;msix_entries);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ivpci_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> minor = iminor(inode);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    ivpci_dev = ivpci_find_private(minor);</span><br><span class="line">    filp-&gt;private_data = (<span class="type">void</span> *) ivpci_dev;</span><br><span class="line">    BUG_ON(filp-&gt;private_data == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;open ivpci\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ivpci_mmap</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> off;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;mmap ivpci bar2\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* `vma-&gt;vm_start` and `vma-&gt;vm_end` had aligned to page size */</span></span><br><span class="line">    WARN_ON(offset_in_page(vma-&gt;vm_start));</span><br><span class="line">    WARN_ON(offset_in_page(vma-&gt;vm_end));</span><br><span class="line"></span><br><span class="line">    off = vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT;</span><br><span class="line">    start = ivpci_dev-&gt;bar2_addr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Align up to page size. */</span></span><br><span class="line">    len = PAGE_ALIGN((start &amp; ~PAGE_MASK) + ivpci_dev-&gt;bar2_len);</span><br><span class="line">    start &amp;= PAGE_MASK;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;mmap vma pgoff: %lu, 0x%0lx - 0x%0lx,&quot;</span> \</span><br><span class="line">            <span class="string">&quot; aligned length: %lu\n&quot;</span>, vma-&gt;vm_pgoff, vma-&gt;vm_start,</span><br><span class="line">            vma-&gt;vm_end, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vma-&gt;vm_end - vma-&gt;vm_start + off &gt; len) &#123;</span><br><span class="line">        dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev,</span><br><span class="line">                PFX <span class="string">&quot;mmap overflow the end, %lu - %lu + %lu &gt; %lu&quot;</span>,</span><br><span class="line">                vma-&gt;vm_end, vma-&gt;vm_start, off, len);</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    off += start;</span><br><span class="line">    vma-&gt;vm_pgoff = off &gt;&gt; PAGE_SHIFT;</span><br><span class="line">    vma-&gt;vm_flags |= VM_IO|VM_SHARED|VM_DONTEXPAND|VM_DONTDUMP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (io_remap_pfn_range(vma, vma-&gt;vm_start, off &gt;&gt; PAGE_SHIFT,</span><br><span class="line">                vma-&gt;vm_end - vma-&gt;vm_start, vma-&gt;vm_page_prot)) &#123;</span><br><span class="line">        dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;mmap bar2 failed\n&quot;</span>);</span><br><span class="line">        ret = -ENXIO;</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">ivpci_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> *buffer, <span class="type">size_t</span> len,</span></span><br><span class="line"><span class="params">        <span class="type">loff_t</span> *poffset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> bytes_read = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    offset = *poffset;</span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;read ivpci bar2, offset: %lu\n&quot;</span>,</span><br><span class="line">            offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* beyoud the end */</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; ivpci_dev-&gt;bar2_len - offset) &#123;</span><br><span class="line">        len = ivpci_dev-&gt;bar2_len - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bytes_read = copy_to_user(buffer, (<span class="type">char</span> *)ivpci_dev-&gt;base_addr + offset,</span><br><span class="line">            len);</span><br><span class="line">    <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev,</span><br><span class="line">                PFX <span class="string">&quot;read ivpci bar2, copy_to_user() failed: %d\n&quot;</span>, bytes_read);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *poffset += len;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">ivpci_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line">    u16 ivposition;</span><br><span class="line">    u16 <span class="built_in">vector</span>;</span><br><span class="line">    u32 value;</span><br><span class="line"></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> IOCTL_RING:</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(&amp;value, (u32 *) arg, <span class="keyword">sizeof</span>(value)) ) &#123;</span><br><span class="line">            dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;copy from user failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">vector</span> = value &amp; <span class="number">0xffff</span>;</span><br><span class="line">        ivposition = value &amp; <span class="number">0xffff0000</span> &gt;&gt; <span class="number">16</span>;</span><br><span class="line">        dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev,</span><br><span class="line">                PFX <span class="string">&quot;ring doorbell: value: %u(0x%x), vector: %u, peer id: %u\n&quot;</span>,</span><br><span class="line">                value, value, <span class="built_in">vector</span>, ivposition);</span><br><span class="line">        writel(value &amp; <span class="number">0xffffffff</span>, ivpci_dev-&gt;regs_addr + DOORBELL_OFF);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> IOCTL_WAIT:</span><br><span class="line">        dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;wait for interrupt\n&quot;</span>);</span><br><span class="line">        ret = wait_event_interruptible(wait_queue, (event_toggle == <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">            dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;wakeup\n&quot;</span>);</span><br><span class="line">            event_toggle = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ret == -ERESTARTSYS) &#123;</span><br><span class="line">            dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;interrupted by signal\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;unknown failed: %d\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> IOCTL_IVPOSITION:</span><br><span class="line">        dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;get ivposition: %u\n&quot;</span>,</span><br><span class="line">                ivpci_dev-&gt;ivposition);</span><br><span class="line">        <span class="keyword">if</span> (copy_to_user((u32 *) arg, &amp;ivpci_dev-&gt;ivposition, <span class="keyword">sizeof</span>(u32))) &#123;</span><br><span class="line">            dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;copy to user failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        dev_err(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;bad ioctl command: %d\n&quot;</span>, cmd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">ivpci_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> len,</span></span><br><span class="line"><span class="params">        <span class="type">loff_t</span> *poffset)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> bytes_written = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> offset;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;write ivpci bar2\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    offset = *poffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &gt; ivpci_dev-&gt;bar2_len - offset) &#123;</span><br><span class="line">        len = ivpci_dev-&gt;bar2_len - offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bytes_written = copy_from_user(ivpci_dev-&gt;base_addr + offset, buffer, len);</span><br><span class="line">    <span class="keyword">if</span> (bytes_written &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *poffset += len;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">loff_t</span> <span class="title function_">ivpci_lseek</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">loff_t</span> offset, <span class="type">int</span> origin)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> retval = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev,</span><br><span class="line">            PFX <span class="string">&quot;lseek ivpci bar2, offset: %llu, origin: %d\n&quot;</span>, offset, origin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (origin) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        offset += filp-&gt;f_pos;</span><br><span class="line">        <span class="comment">/* fall through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        retval = offset;</span><br><span class="line">        <span class="keyword">if</span> (offset &gt; ivpci_dev-&gt;bar2_len) &#123;</span><br><span class="line">            offset = ivpci_dev-&gt;bar2_len;</span><br><span class="line">        &#125;</span><br><span class="line">        filp-&gt;f_pos = offset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ivpci_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line">    ivpci_dev = (<span class="keyword">struct</span> ivpci_private *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line">    BUG_ON(ivpci_dev-&gt;base_addr == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;ivpci_dev-&gt;dev-&gt;dev, PFX <span class="string">&quot;release ivpci\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">ivpci_ops</span> =</span> &#123;</span><br><span class="line">    .owner          = THIS_MODULE,</span><br><span class="line">    .open           = ivpci_open,</span><br><span class="line">    .mmap           = ivpci_mmap,</span><br><span class="line">    .unlocked_ioctl = ivpci_ioctl,</span><br><span class="line">    .read           = ivpci_read,</span><br><span class="line">    .write          = ivpci_write,</span><br><span class="line">    .llseek         = ivpci_lseek,</span><br><span class="line">    .release        = ivpci_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ivpci_probe</span><span class="params">(<span class="keyword">struct</span> pci_dev *pdev, <span class="type">const</span> <span class="keyword">struct</span> pci_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line">    <span class="type">dev_t</span> devno;</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;probing for device: %s\n&quot;</span>, pci_name(pdev));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_ivpci_count &gt;= g_max_devices) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;reach the maxinum number of devices, &quot;</span> \</span><br><span class="line">                <span class="string">&quot;please adapt the `g_max_devices` value, reload the driver\n&quot;</span>);</span><br><span class="line">        ret = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = pci_enable_device(pdev);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to enable device: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reserved PCI I/O and memory resources for this device */</span></span><br><span class="line">    ret = pci_request_regions(pdev, DRV_NAME);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to reserve resources: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> disable_device;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ivpci_dev = ivpci_get_private();</span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pci_read_config_byte(pdev, PCI_REVISION_ID, &amp;ivpci_dev-&gt;revision);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;device %d:%d, revision: %d\n&quot;</span>, g_ivpci_major,</span><br><span class="line">            ivpci_dev-&gt;minor, ivpci_dev-&gt;revision);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pysical address of BAR0, BAR1, BAR2 */</span></span><br><span class="line">    ivpci_dev-&gt;bar0_addr = pci_resource_start(pdev, <span class="number">0</span>);</span><br><span class="line">    ivpci_dev-&gt;bar0_len = pci_resource_len(pdev, <span class="number">0</span>);</span><br><span class="line">    ivpci_dev-&gt;bar1_addr = pci_resource_start(pdev, <span class="number">1</span>);</span><br><span class="line">    ivpci_dev-&gt;bar1_len = pci_resource_len(pdev, <span class="number">1</span>);</span><br><span class="line">    ivpci_dev-&gt;bar2_addr = pci_resource_start(pdev, <span class="number">2</span>);</span><br><span class="line">    ivpci_dev-&gt;bar2_len = pci_resource_len(pdev, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;BAR0: 0x%0x, %d\n&quot;</span>, ivpci_dev-&gt;bar0_addr,</span><br><span class="line">            ivpci_dev-&gt;bar0_len);</span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;BAR1: 0x%0x, %d\n&quot;</span>, ivpci_dev-&gt;bar1_addr,</span><br><span class="line">            ivpci_dev-&gt;bar1_len);</span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;BAR2: 0x%0x, %d\n&quot;</span>, ivpci_dev-&gt;bar2_addr,</span><br><span class="line">            ivpci_dev-&gt;bar2_len);</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;regs_addr = ioremap(ivpci_dev-&gt;bar0_addr, ivpci_dev-&gt;bar0_len);</span><br><span class="line">    <span class="keyword">if</span> (!ivpci_dev-&gt;regs_addr) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to ioremap bar0, size: %d\n&quot;</span>,</span><br><span class="line">                ivpci_dev-&gt;bar0_len);</span><br><span class="line">        <span class="keyword">goto</span> release_regions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;base_addr = ioremap(ivpci_dev-&gt;bar2_addr, ivpci_dev-&gt;bar2_len);</span><br><span class="line">    <span class="keyword">if</span> (!ivpci_dev-&gt;base_addr) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to ioremap bar2, size: %d\n&quot;</span>,</span><br><span class="line">                ivpci_dev-&gt;bar2_len);</span><br><span class="line">        <span class="keyword">goto</span> iounmap_bar0;</span><br><span class="line">    &#125;</span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;BAR2 map: %p\n&quot;</span>, ivpci_dev-&gt;base_addr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Create character device file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    cdev_init(&amp;ivpci_dev-&gt;cdev, &amp;ivpci_ops);</span><br><span class="line">    ivpci_dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    devno = MKDEV(g_ivpci_major, ivpci_dev-&gt;minor);</span><br><span class="line">    ret = cdev_add(&amp;ivpci_dev-&gt;cdev, devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to add chrdev %d:%d to system: %d\n&quot;</span>,</span><br><span class="line">                g_ivpci_major, ivpci_dev-&gt;minor, ret);</span><br><span class="line">        <span class="keyword">goto</span> iounmap_bar2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device_create(g_ivpci_class, <span class="literal">NULL</span>, devno, <span class="literal">NULL</span>, DRV_FILE_FMT,</span><br><span class="line">                ivpci_dev-&gt;minor) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        dev_err(&amp;pdev-&gt;dev, PFX <span class="string">&quot;unable to create device file: %d:%d\n&quot;</span>,</span><br><span class="line">                g_ivpci_major, ivpci_dev-&gt;minor);</span><br><span class="line">        <span class="keyword">goto</span> delete_chrdev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;dev = pdev;</span><br><span class="line">    pci_set_drvdata(pdev, ivpci_dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ivpci_dev-&gt;revision == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* Only process the MSI-X interrupt. */</span></span><br><span class="line">        ivpci_dev-&gt;ivposition = ioread32(ivpci_dev-&gt;regs_addr + IVPOSITION_OFF);</span><br><span class="line"></span><br><span class="line">        dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;device ivposition: %u, MSI-X: %s\n&quot;</span>,</span><br><span class="line">                ivpci_dev-&gt;ivposition,</span><br><span class="line">                (ivpci_dev-&gt;ivposition == <span class="number">0</span>) ? <span class="string">&quot;no&quot;</span>: <span class="string">&quot;yes&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ivpci_dev-&gt;ivposition != <span class="number">0</span>) &#123;</span><br><span class="line">            ret = ivpci_request_msix_vectors(ivpci_dev, <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">goto</span> destroy_device;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_ivpci_count++;</span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;device probed: %s\n&quot;</span>, pci_name(pdev));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">destroy_device:</span><br><span class="line">    devno = MKDEV(g_ivpci_major, ivpci_dev-&gt;minor);</span><br><span class="line">    device_destroy(g_ivpci_class, devno);</span><br><span class="line">    ivpci_dev-&gt;dev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">delete_chrdev:</span><br><span class="line">    cdev_del(&amp;ivpci_dev-&gt;cdev);</span><br><span class="line"></span><br><span class="line">iounmap_bar2:</span><br><span class="line">    iounmap(ivpci_dev-&gt;base_addr);</span><br><span class="line"></span><br><span class="line">iounmap_bar0:</span><br><span class="line">    iounmap(ivpci_dev-&gt;regs_addr);</span><br><span class="line"></span><br><span class="line">release_regions:</span><br><span class="line">    pci_release_regions(pdev);</span><br><span class="line"></span><br><span class="line">disable_device:</span><br><span class="line">    pci_disable_device(pdev);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    pci_set_drvdata(pdev, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ivpci_remove</span><span class="params">(<span class="keyword">struct</span> pci_dev *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> devno;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ivpci_private</span> *<span class="title">ivpci_dev</span>;</span></span><br><span class="line"></span><br><span class="line">    dev_info(&amp;pdev-&gt;dev, PFX <span class="string">&quot;removing ivshmem device: %s\n&quot;</span>, pci_name(pdev));</span><br><span class="line"></span><br><span class="line">    ivpci_dev = pci_get_drvdata(pdev);</span><br><span class="line">    BUG_ON(ivpci_dev == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    ivpci_free_msix_vectors(ivpci_dev);</span><br><span class="line"></span><br><span class="line">    ivpci_dev-&gt;dev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    devno = MKDEV(g_ivpci_major, ivpci_dev-&gt;minor);</span><br><span class="line">    device_destroy(g_ivpci_class, devno);</span><br><span class="line"></span><br><span class="line">    cdev_del(&amp;ivpci_dev-&gt;cdev);</span><br><span class="line"></span><br><span class="line">    iounmap(ivpci_dev-&gt;base_addr);</span><br><span class="line">    iounmap(ivpci_dev-&gt;regs_addr);</span><br><span class="line"></span><br><span class="line">    pci_release_regions(pdev);</span><br><span class="line">    pci_disable_device(pdev);</span><br><span class="line">    pci_set_drvdata(pdev, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_driver</span> <span class="title">ivpci_driver</span> =</span> &#123;</span><br><span class="line">    .name       = DRV_NAME,</span><br><span class="line">    .id_table   = ivpci_id_table,</span><br><span class="line">    .probe      = ivpci_probe,</span><br><span class="line">    .remove     = ivpci_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ivpci_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret, i, minor;</span><br><span class="line"></span><br><span class="line">    pr_info(PFX <span class="string">&quot;*********************************************************\n&quot;</span>);</span><br><span class="line">    pr_info(PFX <span class="string">&quot;module loading\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = alloc_chrdev_region(&amp;g_ivpci_devno, <span class="number">0</span>, g_max_devices, DRV_NAME);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(PFX <span class="string">&quot;unable to allocate major number: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_ivpci_devs = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ivpci_private) * g_max_devices,</span><br><span class="line">            GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (g_ivpci_devs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> unregister_chrdev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    minor = MINOR(g_ivpci_devno);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; g_max_devices; i++) &#123;</span><br><span class="line">        g_ivpci_devs[i].minor = minor++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_ivpci_class = class_create(THIS_MODULE, DRV_NAME);</span><br><span class="line">    <span class="keyword">if</span> (g_ivpci_class == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pr_err(PFX <span class="string">&quot;unable to create the struct class\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> free_devs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_ivpci_major = MAJOR(g_ivpci_devno);</span><br><span class="line">    pr_info(PFX <span class="string">&quot;major: %d, minor: %d\n&quot;</span>, g_ivpci_major, MINOR(g_ivpci_devno));</span><br><span class="line"></span><br><span class="line">    ret = pci_register_driver(&amp;ivpci_driver);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        pr_err(PFX <span class="string">&quot;unable to register driver: %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">goto</span> destroy_class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pr_info(PFX <span class="string">&quot;module loaded\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">destroy_class:</span><br><span class="line">    class_destroy(g_ivpci_class);</span><br><span class="line"></span><br><span class="line">free_devs:</span><br><span class="line">    kfree(g_ivpci_devs);</span><br><span class="line"></span><br><span class="line">unregister_chrdev:</span><br><span class="line">    unregister_chrdev_region(g_ivpci_devno, g_max_devices);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ivpci_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pci_unregister_driver(&amp;ivpci_driver);</span><br><span class="line"></span><br><span class="line">    class_destroy(g_ivpci_class);</span><br><span class="line"></span><br><span class="line">    kfree(g_ivpci_devs);</span><br><span class="line"></span><br><span class="line">    unregister_chrdev_region(g_ivpci_devno, g_max_devices);</span><br><span class="line"></span><br><span class="line">    pr_info(PFX <span class="string">&quot;module unloaded\n&quot;</span>);</span><br><span class="line">    pr_info(PFX <span class="string">&quot;*********************************************************\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************</span></span><br><span class="line"><span class="comment"> * Just for eliminating the compiling warnings.</span></span><br><span class="line"><span class="comment"> ************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> my_module_init(initfn)					\</span></span><br><span class="line"><span class="meta">	static inline initcall_t __inittest(void)		\</span></span><br><span class="line"><span class="meta">	&#123; return initfn; &#125;					\</span></span><br><span class="line"><span class="meta">	int init_module(void) __cold __attribute__((alias(#initfn)));</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> my_module_exit(exitfn)					\</span></span><br><span class="line"><span class="meta">	static inline exitcall_t __exittest(void)		\</span></span><br><span class="line"><span class="meta">	&#123; return exitfn; &#125;					\</span></span><br><span class="line"><span class="meta">	void cleanup_module(void) __cold __attribute__((alias(#exitfn)));</span></span><br><span class="line"></span><br><span class="line">my_module_init(ivpci_init);</span><br><span class="line">my_module_exit(ivpci_exit);</span><br><span class="line"></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;flygoast@126.com&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Demo PCI driver for ivshmem device&quot;</span>);</span><br><span class="line">MODULE_VERSION(DRV_VERSION);</span><br></pre></td></tr></table></figure>

<p>简单解释一下代码逻辑。驱动被加载时，会调用<code>ivpci_init</code>。我们希望所有的<code>ivshmem</code>设备使用相同的设备<code>major</code>号，因而在这里调用<code>alloc_chrdev_region</code>申请足够的<code>major</code>和<code>minor</code>号，接着创建出足够的<code>ivshmem</code>设备所需的数据结构<code>struct ivpci_private</code>，并将<code>minor</code>号存储在这些结构中。接着，创建设备文件<code>class</code>, 然后注册<code>ivshmem</code>设备的驱动结构。</p>
<p>当<code>ivshmem</code>设备被检测到，<code>probe</code>函数<code>ivpci_probe</code>会被调用。我们调用<code>pci_enable_device</code>启用该设备，并将<code>PCI</code>设备的3个<code>BAR</code>空间映射到内存空间，方便后续访问。然后创建对应的设备文件，给用户态程序提供访问接口。</p>
<p><code>QEMU-2.6.0</code>之后，<code>ivshmem</code>虚拟<code>PCI</code>设备配置空间的<code>revision</code>字段为<code>1</code>，这样才支持<code>MSI-X</code>中断机制，所以我们只处理<code>revision</code>为<code>1</code>的<code>ivshmem</code>设备。</p>
<p>接下来，函数<code>ivpci_request_msix_vectors</code>调用<code>pci_enable_msix</code>分配中断向量，然后依次调用<code>request_irq</code>注册我们的中断处理程序:<code>ivpci_interrupt</code>。 </p>
<p>示例程序里简单使用<code>waitqueue</code>来实现等待和通知。当用户态程序以<code>IOCTL_WAIT</code>命令调用<code>ioctl</code>时，就让该进程在<code>waitqueue</code>上进行等待。当中断触发时，我们的中断处理程序会调用<code>wake_up_interruptible</code>唤醒<code>waitqueue</code>上所等待的进程。</p>
<p>设备文件的文件操作的<code>mmap</code>实现可以把设备<code>BAR2</code>空间映射到用户空间，与之前的文章<a href="/2021/09/12/qemu-ivshmem/">&lt;&lt;QEMU虚拟机内识别ivshmem设备&gt;&gt;</a>中介绍的用户态程序直接<code>mmap</code> <code>sysfs</code>下的<code>resource2</code>文件作用是一致的。</p>
<p>示例的用户态代码，<code>ioctl.c</code>如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_MAGIC         (<span class="string">&#x27;f&#x27;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_RING          _IOW(IOCTL_MAGIC, 1, __u32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_WAIT          _IO(IOCTL_MAGIC, 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOCTL_IVPOSITION    _IOR(IOCTL_MAGIC, 3, __u32)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: \n&quot;</span>  \</span><br><span class="line">           <span class="string">&quot;  ioctl &lt;devfile&gt; ivposition\n&quot;</span>    \</span><br><span class="line">           <span class="string">&quot;  ioctl &lt;devfile&gt; wait\n&quot;</span>          \</span><br><span class="line">           <span class="string">&quot;  ioctl &lt;devfile&gt; ring &lt;peer_id&gt; &lt;vector_id&gt;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd, arg, ret, <span class="built_in">vector</span>, peer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(argv[<span class="number">1</span>], O_RDWR);</span><br><span class="line">    assert(fd != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = ioctl(fd, IOCTL_IVPOSITION, &amp;peer);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IVPOSITION: %d\n&quot;</span>, peer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">&quot;ivposition&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">&quot;wait&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">            usage();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;wait:\n&quot;</span>);</span><br><span class="line">        ret = ioctl(fd, IOCTL_WAIT, &amp;arg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">2</span>], <span class="string">&quot;ring&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (argc != <span class="number">5</span>) &#123;</span><br><span class="line">            usage();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ring:\n&quot;</span>);</span><br><span class="line">        peer = atoi(argv[<span class="number">3</span>]);</span><br><span class="line">        <span class="built_in">vector</span> = atoi(argv[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        arg = ((peer &amp; <span class="number">0xffff</span>) &lt;&lt; <span class="number">16</span>) | (<span class="built_in">vector</span> &amp; <span class="number">0xffff</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;arg: 0x%x\n&quot;</span>, arg);</span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, IOCTL_RING, &amp;arg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid command: %s\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">        usage();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ioctl finished, returned value: %d\n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Makefile</code>如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_MODULE_SIG=n</span><br><span class="line"></span><br><span class="line">obj-m += ivpci.o</span><br><span class="line">all:</span><br><span class="line">	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules</span><br><span class="line">	gcc -g -O0 ioctl.c -o ioctl</span><br><span class="line">clean:</span><br><span class="line">	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</span><br><span class="line">	rm -rf ioctl</span><br></pre></td></tr></table></figure>

<p>编译执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>接下来，在宿主机上运行<code>ivshmem-server</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u qemu /tmp/ivshmem-server -l 4M -M fg-doorbell -n 8 -F -v</span><br></pre></td></tr></table></figure>

<p>由于<code>ivshmem-server</code>分配的第一个<code>peer_id</code>为<code>0</code>, 而当<code>ivshmem</code>设备的<code>ivposition</code>为<code>0</code>时，无法判断是不支持<code>MSI-X</code>中断还是分配的<code>peer_id</code>为<code>0</code>。所以我们可以先调用<code>ivshmem-client</code>程序来先连接<code>ivshmem-server</code>来占据<code>0</code>号<code>peer_id</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@controller qemu-2.6.0]# ./ivshmem-client</span><br><span class="line">dump: dump peers (including us)</span><br><span class="line">int &lt;peer&gt; &lt;vector&gt;: notify one vector on a peer</span><br><span class="line">int &lt;peer&gt; all: notify all vectors of a peer</span><br><span class="line">int all: notify all vectors of all peers (excepting us)</span><br><span class="line">cmd&gt; listen on server socket 3</span><br><span class="line">dump</span><br><span class="line">our_id = 0</span><br><span class="line">  vector 0 is enabled (fd=5)</span><br><span class="line">  vector 1 is enabled (fd=6)</span><br><span class="line">  vector 2 is enabled (fd=7)</span><br><span class="line">  vector 3 is enabled (fd=8)</span><br><span class="line">  vector 4 is enabled (fd=9)</span><br><span class="line">  vector 5 is enabled (fd=10)</span><br><span class="line">  vector 6 is enabled (fd=11)</span><br><span class="line">  vector 7 is enabled (fd=12)</span><br><span class="line">cmd&gt;</span><br></pre></td></tr></table></figure>

<p>接下来启动两台虚拟机，分别给两台虚拟机各动态添加一个<code>ivshmem-plain</code>和一个<code>ivshmem-doorbell</code>设备:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">virsh qemu-monitor-command --hmp 4 <span class="string">&quot;object_add  memory-backend-file,size=8M,share,mem-path=/dev/shm/shm2,id=shm2&quot;</span></span><br><span class="line">virsh qemu-monitor-command --hmp 4 <span class="string">&quot;device_add  ivshmem-plain,memdev=shm2,bus=pci.0,addr=0x1f,master=on&quot;</span></span><br><span class="line">virsh qemu-monitor-command --hmp 4 <span class="string">&quot;chardev-add socket,path=/tmp/ivshmem_socket,id=fg-doorbell&quot;</span></span><br><span class="line">virsh qemu-monitor-command --hmp 4 <span class="string">&quot;device_add ivshmem-doorbell,chardev=fg-doorbell,vectors=8&quot;</span></span><br></pre></td></tr></table></figure>

<p>在两台虚拟机中都装载驱动模块:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insmod ./ivpci.ko</span><br></pre></td></tr></table></figure>

<p><code>dmesg</code>查看加载信息, 如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[ 7204.791580] [IVPCI] *********************************************************</span><br><span class="line">[ 7204.791583] [IVPCI] module loading</span><br><span class="line">[ 7204.791592] [IVPCI] major: 244, minor: 0</span><br><span class="line">[ 7204.791613] ivpci 0000:00:1f.0: [IVPCI] probing for device: 0000:00:1f.0</span><br><span class="line">[ 7204.791677] ivpci 0000:00:1f.0: [IVPCI] device 244:0, revision: 1</span><br><span class="line">[ 7204.791680] ivpci 0000:00:1f.0: [IVPCI] BAR0: 0xfebd3000, 256</span><br><span class="line">[ 7204.791682] ivpci 0000:00:1f.0: [IVPCI] BAR1: 0x0, 0</span><br><span class="line">[ 7204.791684] ivpci 0000:00:1f.0: [IVPCI] BAR2: 0xfe000000, 8388608</span><br><span class="line">[ 7204.791696] ivpci 0000:00:1f.0: [IVPCI] BAR2 map: ffffade482000000</span><br><span class="line">[ 7204.792366] ivpci 0000:00:1f.0: [IVPCI] device ivposition: 0, MSI-X: no</span><br><span class="line">[ 7204.792369] ivpci 0000:00:1f.0: [IVPCI] device probed: 0000:00:1f.0</span><br><span class="line">[ 7204.792379] ivpci 0000:00:06.0: [IVPCI] probing for device: 0000:00:06.0</span><br><span class="line">[ 7204.792414] ivpci 0000:00:06.0: [IVPCI] device 244:1, revision: 1</span><br><span class="line">[ 7204.792416] ivpci 0000:00:06.0: [IVPCI] BAR0: 0x80401000, 256</span><br><span class="line">[ 7204.792418] ivpci 0000:00:06.0: [IVPCI] BAR1: 0x80400000, 4096</span><br><span class="line">[ 7204.792420] ivpci 0000:00:06.0: [IVPCI] BAR2: 0x80000000, 4194304</span><br><span class="line">[ 7204.792429] ivpci 0000:00:06.0: [IVPCI] BAR2 map: ffffade481800000</span><br><span class="line">[ 7204.796436] ivpci 0000:00:06.0: [IVPCI] device ivposition: 1, MSI-X: yes</span><br><span class="line">[ 7204.796440] ivpci 0000:00:06.0: [IVPCI] request msi-x vectors: 4</span><br><span class="line">[ 7204.796526] ivpci 0000:00:06.0: irq 29 for MSI/MSI-X</span><br><span class="line">[ 7204.796579] ivpci 0000:00:06.0: irq 30 for MSI/MSI-X</span><br><span class="line">[ 7204.796602] ivpci 0000:00:06.0: irq 31 for MSI/MSI-X</span><br><span class="line">[ 7204.796624] ivpci 0000:00:06.0: irq 32 for MSI/MSI-X</span><br><span class="line">[ 7204.797082] ivpci 0000:00:06.0: [IVPCI] irq for msix entry: 0, vector: 29</span><br><span class="line">[ 7204.797123] ivpci 0000:00:06.0: [IVPCI] irq for msix entry: 1, vector: 30</span><br><span class="line">[ 7204.797162] ivpci 0000:00:06.0: [IVPCI] irq for msix entry: 2, vector: 31</span><br><span class="line">[ 7204.797201] ivpci 0000:00:06.0: [IVPCI] irq for msix entry: 3, vector: 32</span><br><span class="line">[ 7204.797203] ivpci 0000:00:06.0: [IVPCI] device probed: 0000:00:06.0</span><br><span class="line">[ 7204.797221] [IVPCI] module loaded</span><br></pre></td></tr></table></figure>

<p>可以看到两个<code>ivshmem</code>设备都被检测到，驱动只对<code>0000:00:06.0</code>设备进行了中断处理。</p>
<p>通过<code>lspci</code>查看该设备, 可以看到<code>MSI-X</code>的<code>Capabilities</code>结构显示支持<code>MSI-X</code>机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-29 ~]# lspci -s 00:06.00 -v</span><br><span class="line">00:06.0 RAM memory: Red Hat, Inc. Inter-VM shared memory (rev 01)</span><br><span class="line">	Subsystem: Red Hat, Inc. QEMU Virtual Machine</span><br><span class="line">	Physical Slot: 6</span><br><span class="line">	Flags: fast devsel</span><br><span class="line">	Memory at 80401000 (32-bit, non-prefetchable) [size=256]</span><br><span class="line">	Memory at 80400000 (32-bit, non-prefetchable) [size=4K]</span><br><span class="line">	Memory at 80000000 (64-bit, prefetchable) [size=4M]</span><br><span class="line">	Capabilities: [40] MSI-X: Enable+ Count=8 Masked-</span><br><span class="line">	Kernel driver in use: ivpci</span><br><span class="line">	Kernel modules: virtio_pci</span><br></pre></td></tr></table></figure>


<p>查看系统的中断信息，可以看到<code>29-32</code>的中断由我们的驱动来处理:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-29 ~]# cat /proc/interrupts</span><br><span class="line">...</span><br><span class="line"> 29:          1   PCI-MSI-edge      ivpci-0</span><br><span class="line"> 30:          9   PCI-MSI-edge      ivpci-1</span><br><span class="line"> 31:          0   PCI-MSI-edge      ivpci-2</span><br><span class="line"> 32:          0   PCI-MSI-edge      ivpci-3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>在其中一台虚拟机上执行用户态程序, 进程被阻塞，<code>peer_id</code>为<code>1</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-29 ~]# ./ioctl /dev/ivpci1 wait</span><br><span class="line">IVPOSITION: 1</span><br><span class="line">wait:</span><br></pre></td></tr></table></figure>

<p>可以看到此时进程进入睡眠状态:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-29 ~]# ps aux |grep ioctl</span><br><span class="line">root      3911  0.0  0.0   4212   352 pts/0    S+   17:06   0:00 ./ioctl /dev/ivpci1 wait</span><br><span class="line">root      3932  0.0  0.0 112708   972 pts/1    S+   17:07   0:00 grep --color=auto ioctl</span><br></pre></td></tr></table></figure>


<p>在另一台机器上执行用户态程序触发对端的<code>1</code>号中断:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-30 ~]# ./ioctl /dev/ivpci1 ring 1 1</span><br><span class="line">IVPOSITION: 2</span><br><span class="line">ring:</span><br><span class="line">arg: 0x10001</span><br><span class="line">ioctl finished</span><br></pre></td></tr></table></figure>

<p>此时，<code>peer_id</code>为<code>1</code>的虚拟机上的用户态进程将从睡眠状态返回:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@host-172-16-0-29 ~]# ./ioctl /dev/ivpci1 wait</span><br><span class="line">IVPOSITION: 1</span><br><span class="line">wait:</span><br><span class="line">ioctl finished, returned value: 0</span><br></pre></td></tr></table></figure>

<p>使用中断机制，可以避免各<code>peer</code>通过轮询进行消息通知，性能更优。但<code>ivshmem-server</code>的实现以及<code>ivshmem</code>机制的服务端与客户端之间的协议设计本身的生产可用性还是有所不足。比如上边提到的第一个<code>peer_id</code>为<code>0</code>。而<code>peer_id</code>的分配机制本身所携带的信息过少，<code>ivshmem-server</code>没有足够的信息来区分哪个设备的<code>peer_id</code>各是多少。在实际生产应用中，需要独立实现<code>注册中心</code>来收集各设备<code>peer_id</code>。这样还需要<code>注册中心</code>与虚拟机内的程序、宿主机上的辅助程序都要具备网络连通性。这本身会对云平台的网络结构带来比较大的依赖。在生产环境中使用中断机制建议对<code>ivshmem-server</code>进行较大完善。</p>
<p>本文对<code>ivshmem-server</code>和中断机制的原理实现的介绍较为粗略，后面再专文继续详细分析<code>ivshmem</code>相关的具体实现。</p>
<p>参考文档:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://betontalpfa.medium.com/oh-no-i-need-to-write-a-pci-driver-2b389720a9d0">https://betontalpfa.medium.com/oh-no-i-need-to-write-a-pci-driver-2b389720a9d0</a></li>
<li><a target="_blank" rel="noopener" href="https://embetronicx.com/linux-device-driver-tutorials/">https://embetronicx.com/linux-device-driver-tutorials/</a></li>
<li><a target="_blank" rel="noopener" href="https://olegkutkov.me/2021/01/07/writing-a-pci-device-driver-for-linux/">https://olegkutkov.me/2021/01/07/writing-a-pci-device-driver-for-linux/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.zarb.org/~trem/kernel/pci/pci-driver.c">http://www.zarb.org/~trem/kernel/pci/pci-driver.c</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/haitaoliang/article/details/22753423">https://blog.csdn.net/haitaoliang/article/details/22753423</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.cloudflare.com/know-your-scm_rights/">https://blog.cloudflare.com/know-your-scm_rights/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cmacdonell/ivshmem-code">https://github.com/cmacdonell/ivshmem-code</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/blob/master/docs/specs/ivshmem-spec.txt">https://github.com/qemu/qemu/blob/master/docs/specs/ivshmem-spec.txt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/PCI/msi-howto.html">https://www.kernel.org/doc/html/latest/PCI/msi-howto.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/PCI/sysfs-pci.html">https://www.kernel.org/doc/html/latest/PCI/sysfs-pci.html</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Virtualization/" rel="tag"># Virtualization</a>
              <a href="/tags/Ivshmem/" rel="tag"># Ivshmem</a>
              <a href="/tags/Qemu/" rel="tag"># Qemu</a>
              <a href="/tags/PCI/" rel="tag"># PCI</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/12/qemu-ivshmem/" rel="prev" title="QEMU虚拟机内识别ivshmem设备">
      <i class="fa fa-chevron-left"></i> QEMU虚拟机内识别ivshmem设备
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/10/04/nfqueue-pod/" rel="next" title="Kubernetes POD环境的NFQUEUE机制">
      Kubernetes POD环境的NFQUEUE机制 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">flygoast</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">flygoast</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v6.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
