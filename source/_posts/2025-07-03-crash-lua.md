---
title: crash脚本工具crash-lua
date: 2025-07-03 10:27:57
tags:
- Kernel
- Lua
categories: MISC
---
`crash`是一个用于分析Linux内核转储文件(`vmcore`)的工具。正在运行的内核安装上`debuginfo`包之后，直接运行`crash`也可以直接分析运行中的内核，这对于分析一些内核问题极为有用。

在我们的某个场景中，需要分析`NFQUEUE`队列中的数据包内容。队列在内核中的表示是结构体`nfqnl_instance`，数据包`sk_buff`通过`nf_queue_entry`结构链在队列`nfqnl_instance`中。

要找到对应的`nfqnl_instance`，需要执行多条`crash`命令:

<!--more-->

* 加载内核模块`nfnetlink_queue`:
```plain
mod -s nfnetlink_queue
```

* 查看索引数字:
```plain
p nfnl_queue_net_id
```

* 获取`net.gen`地址:
```plain
net.gen init_net
```

* 通过上述步骤获取的地址进一步获取`net_generic.ptr`:

```plain
struct net_generic.ptr 0xffff9312763e5680
```

* 从上述步骤获取地址读取若干地址:
```plain
rd -x 0xffffa08279cda518 12
```

* 根据第二步中获取的索引数字找到`nfnl_queue_net`的地址，并进一步查看其结构:
```plain
struct nfnl_queue_net ffffa0852b249900
```

* 从中找到`nfqnl_instance`结构地址并查看:
```plain
struct nfqnl_instance 0xffff931109f736c0
```

* 从中通过链表找到所有的`nf_queue_entry`进行查看:
```plain
struct nf_queue_entry 0xffff931529496d80
```

整个过程是有顺序依赖的，后序步骤的命令需要前边步骤所返回的地址。每次分析都需要从头手动执行一遍效率太低，因而期望可以有批量执行命令脚本的能力。

`crash`支持通过`-i`参数或者`<`符号读入批量命令进行执行，但这种方式需要把所有的命令提前写入文件。对于我们这种后序命令依赖前序命令的结果，这种方式就不奏效了。

经过查阅，发现`crash`工具支持`so`扩展，可以通过`C`语言开发`crash`扩展，可以参考:
* https://github.com/crash-utility/crash/tree/master/extensions


我们可以在自定义扩展中依次调用`crash`命令，并解析命令输出，进而拼接出后序命令。当然，用`C`语言解析命令字符串输出的这种逻辑开发效率较低，我们可以将执行命令的能力导出到`Lua`语言中，由`Lua`脚本来解析命令输出，从而给`crash`添加上执行脚本的能力。

上述查找`nfqnl_instance`的逻辑可以通过`Lua`脚本来完成:
```lua
require "crash"

local result = crash.exec_command("mod -s nfnetlink_queue")
print(result)

local result = crash.exec_command("p nfnl_queue_net_id")
local idx = result:match(".*=%s*(%d+)%s*$")
print("index: " .. idx)

local result = crash.exec_command("struct net.gen init_net")
print(result)

local start_pos = result:find("=") + 1
local result = result:sub(start_pos):match("^%s*(.*)")

print(result)

command = string.format("struct net_generic.ptr %s", result)

local result = crash.exec_command(command)
print(result)

local start_pos = result:find("=") + 1
local result = result:sub(start_pos):match("^%s*(.*)")
print(result)

command = string.format("rd -x %s %s", result, idx)
local result = crash.exec_command(command)
local result = result:match("([0-9a-f]+)[,%s]*$")
print(result)

command = string.format("struct nfnl_queue_net %s", result)
local result = crash.exec_command(command)
print(result)
```

扩展的实现位于:
* https://github.com/flygoast/crash-lua

参考:
* https://github.com/fujitsu/crash-trace
* https://github.com/crash-utility/crash/tree/master/extensions

